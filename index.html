<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GitHub Organization Repos</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
	<div class="container mt-5" id="content"></div>
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script>
	/* Modify the following two lines */
	const token='YOUR_GITHUB_API_TOKEN';
	const organizations=['THE','LIST','OF','YOUR','ORGANIZATIONS'];

	 /* Do not modify below this line */
	const repo='NicholasCaporusso/github-organization-dashboard';

	document.addEventListener("DOMContentLoaded",function(){
		checkRepoUpdate();
		for(let i=0;i<organizations.length;i++){
			document.getElementById('content').innerHTML+=`<div class="organization" data-name="${organizations[i]}">
					<h3>${organizations[i]}</h3>
					<h5>Repositories</h5>
					<table class="table repos d-none">
						<thead>
							<tr>
							<th scope="col">Name and description</th>
							<th scope="col">Last updated</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
					<h5>Projects</h5>
					<table class="table projects d-none">
						<thead>
							<tr>
							<th scope="col">Name and description</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>`;
			fetchOrganizationRepos(organizations[i]);
			fetchOrganizationProjects(organizations[i]);
		}
	});


	function fetchOrganizationRepos(organizationName){
		fetch(`https://api.github.com/orgs/${organizationName}/repos`, {
			headers:{
				'Authorization': `token ${token}`
			}
		}).then(response => response.json()).then(data => {
				const container=document.querySelector(`#content .organization[data-name=${organizationName}] .repos tbody`);
				if(data.length>0) document.querySelector(`#content .organization[data-name=${organizationName}] .repos`).classList.remove('d-none');
				data.forEach(repo=>{
					const cardHtml= `
						<tr>
							<td>
								<div><a href="${repo.html_url}" target="_blank">${repo.name}</a></div>
								<small>${repo.description || ''}</small>
							</td>
							<td>${repo.pushed_at || ''}</td>
						</tr>
					`;
					container.innerHTML += cardHtml;
				});
			})
			.catch(error => console.error('Error fetching data: ', error));
	}

	function fetchOrganizationProjects(organizationName){
		const graphqlQuery = {
			query: `
				query($orgName: String!) {
					organization(login: $orgName) {
						projectsV2(first: 10) {
							nodes {
								title
								url
								shortDescription
							}
						}
					}
				}
			`,
			variables: {
				orgName: organizationName
			}
		};

		fetch('https://api.github.com/graphql', {
			method: 'POST',
			headers: {
				'Authorization': `Bearer ${token}`,
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(graphqlQuery)
		})
		.then(response => response.json())
		.then(data => {
		console.log(data);
			const projects = data.data.organization.projectsV2.nodes;
			const container=document.querySelector(`#content .organization[data-name=${organizationName}] .projects tbody`);
			if(projects.length>0) document.querySelector(`#content .organization[data-name=${organizationName}] .projects`).classList.remove('d-none');
			projects.forEach(project => {
				const cardHtml = `
						<tr>
							<td>
								<div><a href="${project.url}" target="_blank">${project.title}</a></div>
								<small>${project.description || 'No description'}</small>
							</td>
						</tr>
				`;
				container.innerHTML += cardHtml;
			});
		})
		.catch(error => console.error('Error fetching data: ', error));
	}



	async function fetchLatestCommitSha() {
		try {
			const response = await fetch(`https://api.github.com/repos/${repo}/commits?per_page=1`);
			const commits = await response.json();
			if (commits.length > 0) {
				return commits[0].sha;
			}
		} catch (error) {
			console.error("Failed to fetch the latest commit:", error);
		}
		return null;
	}

	async function checkRepoUpdate() {
		const latestSha = await fetchLatestCommitSha();
		if (latestSha) {
			const storedSha = localStorage.getItem('latestCommitSha');
			if(!storedSha){
				localStorage.setItem('latestCommitSha', latestSha);
				console.log("Initial commit SHA stored.");
			}else if (storedSha !== latestSha) {
				alert(`The repository has been updated, please download the latest version from https://github.com/${repo}!`);
				//localStorage.setItem('latestCommitSha', latestSha);
			}
		}
	}
	</script>
</body>
</html>